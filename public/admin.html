<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ROCKYSTORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-light: #f0f9ff; --accent-blue: #0ea5e9; --deep-blue: #0369a1; --white: #ffffff; --text-gray: #64748b; --success-green: #10b981; --danger-red: #f43f5e; --sidebar-w: 280px; }
        
        body { font-family: 'Kanit', sans-serif; background: var(--bg-light); margin: 0; display: flex; min-height: 100vh; overflow-x: hidden; }

        /* Sidebar & Navigation */
        .sidebar { width: var(--sidebar-w); background: var(--white); border-right: 1px solid #e0f2fe; padding: 30px 20px; position: fixed; height: 100vh; box-sizing: border-box; transition: 0.3s; z-index: 1000; }
        .logo-box { text-align: center; margin-bottom: 40px; }
        .nav-item { padding: 14px 20px; margin: 6px 0; cursor: pointer; border-radius: 12px; transition: 0.2s; color: var(--text-gray); display: flex; align-items: center; gap: 12px; font-weight: 500; font-size: 0.95rem; }
        .nav-item:hover, .nav-item.active { background: #f0f9ff; color: var(--deep-blue); font-weight: 600; }

        /* Main Content */
        .main-content { flex: 1; margin-left: var(--sidebar-w); padding: 40px; transition: 0.3s; width: calc(100% - var(--sidebar-w)); box-sizing: border-box; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI Components */
        .card { background: var(--white); padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(14, 165, 233, 0.04); border: 1px solid #e0f2fe; margin-bottom: 25px; }
        h2 { color: var(--deep-blue); font-weight: 700; font-size: 1.5rem; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; }
        .revenue-box { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 25px; border-radius: 20px; text-align: center; margin-bottom: 25px; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }

        /* Table */
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; }
        .sales-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .sales-table th, .sales-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .sales-table th { color: var(--deep-blue); background: #f8fafc; font-weight: 600; font-size: 0.9rem; }

        /* Forms & Inputs (Updated for new features) */
        .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select, textarea { padding: 12px 15px; border-radius: 10px; border: 1px solid #bae6fd; font-family: 'Kanit'; outline: none; transition: 0.3s; font-size: 0.95rem; width: 100%; box-sizing: border-box; }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }
        
        .full-width { grid-column: 1 / -1; } /* ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ñ‡∏ß */
        
        .file-input-wrapper { position: relative; display: flex; gap: 10px; align-items: center; }
        .file-input-wrapper input[type="file"] { padding: 8px; background: white; font-size: 0.85rem; }

        .btn-primary { background: linear-gradient(90deg, var(--deep-blue), var(--accent-blue)); color: white; border: none; padding: 14px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; width: 100%; font-size: 1rem; }
        .btn-warning { background: #f59e0b; color: white; border: none; padding: 14px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; display: none; }
        .btn-cancel { background: #94a3b8; color: white; border: none; padding: 14px 25px; border-radius: 12px; font-weight: 600; cursor: pointer; width: 100%; display: none; margin-top: 10px; }
        
        .btn-action-group { display: flex; gap: 5px; }
        .btn-edit { background: #e0f2fe; color: var(--accent-blue); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-del { background: #fee2e2; color: var(--danger-red); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; }

        /* Mobile Header */
        .mobile-header { display: none; background: white; padding: 15px 20px; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0f2fe; position: sticky; top: 0; z-index: 1001; }
        .hamburger { font-size: 1.5rem; color: var(--deep-blue); cursor: pointer; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 999; }
        .overlay.active { display: block; }

        @media (max-width: 992px) {
            .sidebar { left: -100%; }
            .sidebar.active { left: 0; box-shadow: 15px 0 30px rgba(0,0,0,0.1); }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .mobile-header { display: flex; }
        }
    </style>
</head>
<body>

    <div class="overlay" onclick="toggleMenu()"></div>

    <div class="mobile-header">
        <div style="font-weight: 800; color: var(--deep-blue); font-size: 1.2rem;">ROCKY ADMIN</div>
        <div class="hamburger" onclick="toggleMenu()"><i class="fa-solid fa-bars"></i></div>
    </div>

    <div class="sidebar">
        <div class="logo-box">
            <h1 style="color:var(--deep-blue); font-size: 1.6rem; margin:0; font-weight: 800;">ROCKY STORE</h1>
            <p style="font-size: 0.75rem; color: var(--text-gray); font-weight: 400; letter-spacing: 1px;">MANAGEMENT SYSTEM</p>
        </div>
        <div class="nav-item active" onclick="switchSection('sales', this)"><i class="fa-solid fa-chart-pie"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</div>
        <div class="nav-item" onclick="switchSection('inventory', this)"><i class="fa-solid fa-boxes-stacked"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-item" onclick="switchSection('users', this)"><i class="fa-solid fa-user-shield"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
        <hr style="border: none; border-top: 1px solid #f1f5f9; margin: 25px 0;">
        <a href="/index.html" class="nav-item" style="text-decoration:none;"><i class="fa-solid fa-arrow-right-from-bracket"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <div class="main-content">
        <div id="sales" class="content-section active">
            <h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
            <div class="revenue-box">
                <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 5px;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <h1 id="total-revenue" style="font-size: 2.5rem; font-weight: 800; margin:0;">0 ‡∏ø</h1>
            </div>
            
            <div class="card">
                <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                    <h3 style="margin:0; font-size: 1.1rem; color: var(--deep-blue);">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size: 0.85rem; color: var(--text-gray);">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</span>
                        <select id="sales-filter" onchange="loadSalesStats()">
                            <option value="desc">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‚Üì</option>
                            <option value="asc">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å ‚Üë</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="sales-table">
                        <thead>
                            <tr><th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</th></tr>
                        </thead>
                        <tbody id="sales-stats-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="inventory" class="content-section">
            <h2>üì¶ ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="card">
                <h3 id="form-title" style="margin-top:0; font-size:1.1rem; color:var(--text-gray);">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="hidden" id="edit-id"> <div class="input-grid">
                    <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô RTX 5050)">
                    <input type="number" id="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢ (‡∏ø)">
                    <select id="category">
                        <option value="monitor">‡∏à‡∏≠‡∏Ñ‡∏≠‡∏°</option><option value="gpu">‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠</option>
                        <option value="case">‡πÄ‡∏Ñ‡∏™‡∏Ñ‡∏≠‡∏°</option><option value="mainboard">‡πÄ‡∏°‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î</option>
                        <option value="cpu">‡∏ã‡∏µ‡∏û‡∏µ‡∏¢‡∏π</option><option value="ram">‡πÅ‡∏£‡∏°</option>
                        <option value="ssd">‡∏Æ‡∏≤‡∏£‡πå‡∏î‡∏î‡∏¥‡∏™ / SSD</option><option value="etc">‡∏à‡∏¥‡∏õ‡∏≤‡∏ñ‡∏∞</option>
                    </select>
                    
                    <div class="file-input-wrapper">
                        <input type="text" id="img" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)">
                        <span style="font-size:0.8rem; color:#aaa;">‡∏´‡∏£‡∏∑‡∏≠</span>
                        <input type="file" id="img-file" accept="image/*" onchange="previewFile()">
                    </div>

                    <textarea id="desc" class="full-width" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 1000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" maxlength="1000"></textarea>
                </div>

                <button id="btn-add" class="btn-primary" onclick="saveProduct()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
                <button id="btn-update" class="btn-warning" onclick="saveProduct()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button id="btn-cancel" class="btn-cancel" onclick="cancelEdit()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
            <div id="admin-display"></div>
        </div>

        <div id="users" class="content-section">
            <h2>üë• ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="card">
                <div class="table-responsive">
                    <table class="sales-table">
                        <thead>
                            <tr><th>Username</th><th>Password</th><th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</th><th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                        </thead>
                        <tbody id="user-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check Admin
        const currentUser = JSON.parse(localStorage.getItem('user'));
        if (!currentUser || currentUser.role !== 'admin') window.location.href = '/login.html';

        let currentBase64 = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ Base64
        let globalProductList = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

        function toggleMenu() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.overlay').classList.toggle('active');
        }

        function switchSection(sectionId, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            el.classList.add('active');
            if(window.innerWidth <= 992) toggleMenu();
        }

        // --- Image Conversion ---
        function previewFile() {
            const file = document.querySelector('input[type=file]').files[0];
            const reader = new FileReader();
            reader.addEventListener("load", function () {
                currentBase64 = reader.result; // ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡πá‡∏ô Text Base64
            }, false);
            if (file) reader.readAsDataURL(file);
        }

        // --- Sales & Inventory Functions ---
        async function loadSalesStats() {
            try {
                const [prodRes, orderRes] = await Promise.all([fetch('/api/products'), fetch('/api/orders')]);
                const allProds = await prodRes.json();
                const orders = await orderRes.json();
                const filterType = document.getElementById('sales-filter').value;
                
                let revenue = 0; let productStats = {};
                orders.forEach(order => {
                    revenue += (order.total || 0);
                    if (order.items) order.items.forEach(itemName => {
                        if (!productStats[itemName]) {
                            const pInfo = allProds.find(p => p.name === itemName);
                            productStats[itemName] = { count: 0, totalCash: 0, price: pInfo ? pInfo.price : 0 };
                        }
                        productStats[itemName].count++;
                        productStats[itemName].totalCash += productStats[itemName].price;
                    });
                });

                document.getElementById('total-revenue').innerText = `${revenue.toLocaleString()} ‡∏ø`;
                const sorted = Object.keys(productStats).map(n => ({ name: n, ...productStats[n] }))
                    .sort((a,b) => filterType === 'asc' ? a.count - b.count : b.count - a.count);

                document.getElementById('sales-stats-list').innerHTML = sorted.map((s, i) => `
                    <tr><td>${i+1}</td><td>${s.name}</td><td>${s.count} ‡∏ä‡∏¥‡πâ‡∏ô</td><td style="font-weight:700; color:var(--deep-blue);">${s.totalCash.toLocaleString()} ‡∏ø</td></tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            } catch (e) { console.error(e); }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡πÅ‡∏•‡∏∞ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        async function saveProduct() {
            const id = document.getElementById('edit-id').value;
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;
            const category = document.getElementById('category').value;
            const desc = document.getElementById('desc').value;
            
            // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå URL
            const img = currentBase64 || document.getElementById('img').value;

            if(!name || !price) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤', 'warning');

            const payload = { name, price: Number(price), img, category, description: desc };
            
            let url = '/api/products';
            let method = 'POST';

            // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ID ‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏û‡∏¥‡πà‡∏° Route PUT ‡πÉ‡∏ô server.js)
            if (id) {
                url = `/api/products/${id}`; // **‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° API PUT ‡πÉ‡∏ô Server**
                method = 'PUT'; 
            }

            try {
                const res = await fetch(url, { 
                    method: method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(payload) 
                });

                if (res.ok) {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    cancelEdit(); // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
                    loadAdminItems();
                } else {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                }
            } catch (err) { console.error(err); }
        }

        async function loadAdminItems() {
            const res = await fetch('/api/products');
            globalProductList = await res.json(); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            document.getElementById('admin-display').innerHTML = globalProductList.map(p => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; margin-bottom:12px; gap:10px;">
                    <div style="flex:1;">
                        <b style="font-weight:600;">${p.name}</b> 
                        <span style="color:var(--accent-blue); margin-left:10px;">${p.price.toLocaleString()} ‡∏ø</span>
                        <div style="font-size:0.8rem; color:#aaa; margin-top:4px;">${(p.description || '').substring(0, 50)}...</div>
                    </div>
                    <div class="btn-action-group">
                        <button class="btn-edit" onclick="prepareEdit('${p._id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-del" onclick="deleteItem('${p._id}')"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>`).join('');
        }

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
        function prepareEdit(id) {
            const p = globalProductList.find(item => item._id === id);
            if (!p) return;

            document.getElementById('form-title').innerText = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ' + p.name;
            document.getElementById('edit-id').value = p._id;
            document.getElementById('name').value = p.name;
            document.getElementById('price').value = p.price;
            document.getElementById('category').value = p.category;
            document.getElementById('img').value = p.img; // ‡πÅ‡∏™‡∏î‡∏á URL ‡πÄ‡∏î‡∏¥‡∏°
            document.getElementById('desc').value = p.description || '';
            currentBase64 = null; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏π‡∏õ‡πÉ‡∏´‡∏°‡πà

            // ‡∏™‡∏•‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('btn-add').style.display = 'none';
            document.getElementById('btn-update').style.display = 'block';
            document.getElementById('btn-cancel').style.display = 'block';
            
            // ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏à‡∏≠‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.querySelector('.content-section.active').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('form-title').innerText = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('edit-id').value = '';
            document.getElementById('name').value = '';
            document.getElementById('price').value = '';
            document.getElementById('img').value = '';
            document.getElementById('img-file').value = '';
            document.getElementById('desc').value = '';
            currentBase64 = null;

            document.getElementById('btn-add').style.display = 'block';
            document.getElementById('btn-update').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'none';
        }

        async function deleteItem(id) {
            const res = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏•‡∏±‡∏á", icon: 'warning', showCancelButton: true, confirmButtonColor: '#f43f5e', confirmButtonText: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' });
            if (res.isConfirmed) { await fetch(`/api/products/${id}`, { method: 'DELETE' }); loadAdminItems(); loadSalesStats(); }
        }

        // --- User Functions ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/users');
                const users = await res.json();
                document.getElementById('user-list').innerHTML = users.map(u => `
                    <tr>
                        <td style="font-weight:500;">${u.username}</td>
                        <td><span style="filter:blur(5px); transition:0.3s; cursor:help;" onclick="this.style.filter='none'">${u.password}</span></td>
                        <td><span style="padding:4px 10px; border-radius:6px; background:${u.role==='admin'?'#fee2e2':'#e0f2fe'}; font-size:0.8rem; font-weight:600;">${u.role.toUpperCase()}</span></td>
                        <td><button class="btn-del" onclick="deleteUser('${u._id}')">‡∏•‡∏ö</button></td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            const res = await Swal.fire({ title: '‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å?', icon: 'error', showCancelButton: true, confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö' });
            if (res.isConfirmed) { await fetch(`/api/users/${id}`, { method: 'DELETE' }); loadUsers(); }
        }

        window.onload = () => { loadAdminItems(); loadSalesStats(); loadUsers(); };
    </script>
</body>
</html>