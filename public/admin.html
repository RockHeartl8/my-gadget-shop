<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - ROCKYSTORE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --bg-light: #f0f9ff; --accent-blue: #0ea5e9; --deep-blue: #0369a1; --white: #ffffff; --text-gray: #64748b; --success-green: #10b981; --danger-red: #f43f5e; --sidebar-w: 280px; }
        body { font-family: 'Kanit', sans-serif; background: var(--bg-light); margin: 0; display: flex; min-height: 100vh; }

        /* Sidebar Design */
        .sidebar { width: var(--sidebar-w); background: var(--white); border-right: 1px solid #e0f2fe; padding: 30px 20px; position: fixed; height: 100vh; box-sizing: border-box; }
        .logo-box { text-align: center; margin-bottom: 40px; }
        .nav-item { padding: 15px 20px; margin: 8px 0; cursor: pointer; border-radius: 12px; transition: 0.3s; color: var(--text-gray); display: flex; align-items: center; gap: 12px; font-weight: 600; }
        .nav-item:hover, .nav-item.active { background: #e0f2fe; color: var(--deep-blue); }

        /* Main Content area */
        .main-content { flex: 1; margin-left: var(--sidebar-w); padding: 40px; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: var(--white); padding: 30px; border-radius: 24px; box-shadow: 0 10px 30px rgba(14, 165, 233, 0.05); border: 1px solid #e0f2fe; margin-bottom: 30px; }
        h2 { color: var(--deep-blue); margin-bottom: 25px; font-weight: 800; display: flex; align-items: center; gap: 10px; }

        /* Table Design */
        .sales-table { width: 100%; border-collapse: collapse; }
        .sales-table th, .sales-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .sales-table th { color: var(--deep-blue); background: #f8fafc; font-weight: 700; }
        
        /* Stats & Inputs */
        .revenue-box { background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 25px; border-radius: 18px; text-align: center; margin-bottom: 25px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, select { padding: 12px 18px; border-radius: 12px; border: 1px solid #bae6fd; font-family: 'Kanit'; outline: none; }
        .btn-primary { background: var(--accent-blue); color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        .btn-del { background: var(--danger-red); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-size: 0.85rem; }
        .nav-back { color: var(--text-gray); text-decoration: none; font-size: 0.9rem; margin-bottom: 20px; display: block; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo-box">
            <h1 style="color:var(--deep-blue); font-size: 1.5rem; margin:0;">ROCKY ADMIN</h1>
            <p style="font-size: 0.7rem; color: var(--text-gray);">System Control Panel</p>
        </div>
        <div class="nav-item active" onclick="switchSection('sales', this)"><i class="fa-solid fa-chart-line"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</div>
        <div class="nav-item" onclick="switchSection('inventory', this)"><i class="fa-solid fa-box-archive"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
        <div class="nav-item" onclick="switchSection('users', this)"><i class="fa-solid fa-users-gear"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
        <hr style="border: none; border-top: 1px solid #f0f9ff; margin: 20px 0;">
        <a href="/index.html" class="nav-item" style="text-decoration:none;"><i class="fa-solid fa-house"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å</a>
    </div>

    <div class="main-content">
        <div id="sales" class="content-section active">
            <h2>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏à‡∏≥‡∏´‡∏ô‡πà‡∏≤‡∏¢</h2>
            <div class="card">
                <div class="revenue-box">
                    <div style="font-size: 0.9rem; opacity: 0.85;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div id="total-revenue" style="font-size: 2.2rem; font-weight: 800;">0 ‡∏ø</div>
                </div>
                <div style="display:flex; justify-content:flex-end; margin-bottom:15px; align-items:center; gap:10px;">
                    <span style="font-size: 0.85rem;">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</span>
                    <select id="sales-filter" onchange="loadSalesStats()" style="padding:5px 10px;">
                        <option value="asc">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å ‚Üë</option>
                        <option value="desc">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‚Üì</option>
                    </select>
                </div>
                <table class="sales-table">
                    <thead>
                        <tr><th>‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°</th></tr>
                    </thead>
                    <tbody id="sales-stats-list"></tbody>
                </table>
            </div>
        </div>

        <div id="inventory" class="content-section">
            <h2>üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
            <div class="card">
                <div class="input-grid">
                    <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
                    <input type="number" id="price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø)">
                    <input type="text" id="img" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (URL)">
                    <select id="category">
                        <option value="monitor">‡∏à‡∏≠‡∏Ñ‡∏≠‡∏°</option><option value="gpu">‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏à‡∏≠</option>
                        <option value="case">‡πÄ‡∏Ñ‡∏™‡∏Ñ‡∏≠‡∏°</option><option value="mainboard">‡πÄ‡∏°‡∏ô‡∏ö‡∏≠‡∏£‡πå‡∏î</option>
                        <option value="cpu">‡∏ã‡∏µ‡∏û‡∏µ‡∏¢‡∏π</option><option value="ram">‡πÅ‡∏£‡∏°</option>
                        <option value="ssd">‡∏Æ‡∏≤‡∏£‡πå‡∏î‡∏î‡∏¥‡∏™ / SSD</option><option value="etc">‡∏à‡∏¥‡∏õ‡∏≤‡∏ñ‡∏∞</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="addProduct()" style="width:100%;">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ñ‡∏•‡∏±‡∏á</button>
            </div>
            <div id="admin-display"></div>
        </div>

        <div id="users" class="content-section">
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</h2>
            <div class="card">
                <table class="sales-table">
                    <thead>
                        <tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Username)</th><th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (Password)</th><th>‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (Role)</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr>
                    </thead>
                    <tbody id="user-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Check Admin Auth
        const currentUser = JSON.parse(localStorage.getItem('user'));
        if (!currentUser || currentUser.role !== 'admin') window.location.href = '/login.html';

        function switchSection(sectionId, el) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            el.classList.add('active');
        }

        // --- Sales & Inventory Functions ---
        async function loadSalesStats() {
            try {
                const [prodRes, orderRes] = await Promise.all([fetch('/api/products'), fetch('/api/orders')]);
                const allProds = await prodRes.json();
                const orders = await orderRes.json();
                const filterType = document.getElementById('sales-filter').value;
                
                let revenue = 0; let productStats = {};
                orders.forEach(order => {
                    revenue += (order.total || 0);
                    if (order.items) order.items.forEach(itemName => {
                        if (!productStats[itemName]) {
                            const pInfo = allProds.find(p => p.name === itemName);
                            productStats[itemName] = { count: 0, totalCash: 0, price: pInfo ? pInfo.price : 0 };
                        }
                        productStats[itemName].count++;
                        productStats[itemName].totalCash += productStats[itemName].price;
                    });
                });

                document.getElementById('total-revenue').innerText = `${revenue.toLocaleString()} ‡∏ø`;
                const sorted = Object.keys(productStats).map(n => ({ name: n, ...productStats[n] }))
                    .sort((a,b) => filterType === 'asc' ? a.count - b.count : b.count - a.count);

                document.getElementById('sales-stats-list').innerHTML = sorted.map((s, i) => `
                    <tr><td>${i+1}</td><td>${s.name}</td><td>${s.count} ‡∏ä‡∏¥‡πâ‡∏ô</td><td style="font-weight:700; color:var(--deep-blue);">${s.totalCash.toLocaleString()} ‡∏ø</td></tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center; padding:20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
            } catch (e) { console.error(e); }
        }

        async function addProduct() {
            const data = { name: document.getElementById('name').value, price: Number(document.getElementById('price').value), img: document.getElementById('img').value, category: document.getElementById('category').value };
            await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => location.reload());
        }

        async function loadAdminItems() {
            const res = await fetch('/api/products');
            const data = await res.json();
            document.getElementById('admin-display').innerHTML = data.map(p => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px 25px; margin-bottom:10px;">
                    <div><b>${p.name}</b> <span style="color:var(--accent-blue); margin-left:10px;">${p.price.toLocaleString()} ‡∏ø</span></div>
                    <button class="btn-del" onclick="deleteItem('${p._id}')">‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                </div>`).join('');
        }

        async function deleteItem(id) {
            if (confirm('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?')) { await fetch(`/api/products/${id}`, { method: 'DELETE' }); loadAdminItems(); loadSalesStats(); }
        }

        // --- User Management Functions ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/users'); // **‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á API GET /api/users ‡πÉ‡∏ô server.js**
                const users = await res.json();
                document.getElementById('user-list').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.username}</td>
                        <td><span style="filter:blur(4px);" onmouseover="this.style.filter='none'" onmouseout="this.style.filter='blur(4px)'">${u.password}</span></td>
                        <td><span style="padding:4px 8px; border-radius:6px; background:${u.role==='admin'?'#fee2e2':'#e0f2fe'}; font-size:0.75rem;">${u.role}</span></td>
                        <td><button class="btn-del" onclick="deleteUser('${u._id}')">‡∏•‡∏ö User</button></td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function deleteUser(id) {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?')) {
                await fetch(`/api/users/${id}`, { method: 'DELETE' }); // **‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á API DELETE /api/users/:id ‡πÉ‡∏ô server.js**
                loadUsers();
            }
        }

        window.onload = () => { loadAdminItems(); loadSalesStats(); loadUsers(); };
    </script>
</body>
</html>